<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>åŒ—äº¬å¤§å­¦ä¸­å…³æ–°å›­ - æˆ¿é—´æ¢ç´¢</title>
    <script type="text/javascript" src="/static/pannellum.js"></script>
    <link rel="stylesheet" href="/static/pannellum.css" />
    <link rel="stylesheet" href="/static/custom.css">
    <link rel="stylesheet" href="/static/default.css">
</head>
<body>

    <div id="panorama-viewer"></div>

    <div id="review-sidebar">
        <button id="toggle-btn" onclick="toggleSidebar()">&times;</button> 

        <div id="sidebar-header">
            <h1 class="site-title">æˆ¿é—´å…¨æ™¯æ¢ç´¢</h1>
            <div class="subtitle">ç‚¹å‡»è¯„è®ºå¯å®šä½æˆ¿é—´å†…ç‰©ä½“</div>
            <a href="/" class="btn-back">è¿”å›é¦–é¡µ</a> 
        </div>

        <div id="all-reviews-section">
            <h3 style="margin-bottom: 10px; color: #333;">ğŸ“ å®¶å…·è¯„ä»·</h3>
            <div id="review-list"></div>

            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">

            <h3 style="margin-bottom: 10px; color: #333;">ğŸ“‹ å…¶ä»– / æ•´ä½“è¯„ä»·</h3>
            <div id="general-review-list"></div>
        </div>
    </div>

    <script>
        let panoramaData = null; 
        let reviewData = null;   

        Promise.all([
            fetch('/static/data.json?t=' + new Date().getTime()).then(r => r.json()),
            fetch('/api/reviews?t=' + new Date().getTime()).then(r => r.json())
        ]).then(([pData, rData]) => {
            panoramaData = pData;
            reviewData = rData;

            initPanorama();      
            renderSidebarList(); 
        });

        // 1. í†µê³„ ê³„ì‚°
        function getEmotionStats(targetName) {
            let counts = {};
            let total = 0;

            reviewData.forEach(review => {
                if (review.sub_reviews) {
                    review.sub_reviews.forEach(sub => {
                        if (sub.target === targetName && sub.emoji) {
                            let emo = sub.emoji;
                            counts[emo] = (counts[emo] || 0) + 1;
                            total++;
                        }
                    });
                }
            });

            if (total === 0) return "æš‚æ— è¯„ä»·"; 

            let sortedStats = Object.keys(counts).map(emo => {
                return { emoji: emo, count: counts[emo] };
            }).sort((a, b) => b.count - a.count);

            let statsString = sortedStats.map(item => {
                let percentage = Math.round((item.count / total) * 100);
                return `${item.emoji} ${percentage}%`;
            }).join("  ");

            return `${statsString}\n(å…±${total}æ¡)`;
        }

        // 2. íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™”
        function initPanorama() {
            const processedHotspots = panoramaData.hotSpots.map(spot => {
                const objectName = spot.text.split(' ')[0].toLowerCase();
                const statsText = getEmotionStats(objectName);
                const displayText = `${objectName.toUpperCase()}\n${statsText}`;
                
                return { ...spot, text: displayText };
            });

            window.panoramaViewer = pannellum.viewer('panorama-viewer', { 
                "type": "equirectangular",
                "panorama": panoramaData.panorama_image,
                "autoLoad": true,
                "hotSpots": processedHotspots,
                "compass": true 
            });
        }

        // 3. ì‚¬ì´ë“œë°” ëª©ë¡ ê·¸ë¦¬ê¸°
        function renderSidebarList() {
            const furnitureContainer = document.getElementById('review-list');
            const generalContainer = document.getElementById('general-review-list');
            
            let furnitureHtml = '';
            let generalHtml = '';
            let displayedReviewIndices = new Set();

            // [Part 1] ê°€êµ¬ë³„ ë¦¬ë·° ë Œë”ë§
            if (!panoramaData.hotSpots || panoramaData.hotSpots.length === 0) {
                furnitureContainer.innerHTML = '<div style="padding:10px; color:#666;">æœªæ£€æµ‹åˆ°å®¶å…·</div>';
            } else {
                panoramaData.hotSpots.forEach((spot, index) => {
                    const objectName = spot.text.split(' ')[0].toLowerCase(); 
                    const displayName = objectName.toUpperCase(); 
                    let matchedSubReviews = [];

                    reviewData.forEach((review, rIndex) => {
                        let targetSub = null;
                        if (review.sub_reviews) {
                            targetSub = review.sub_reviews.find(sub => sub.target === objectName);
                        }

                        if (targetSub) {
                            matchedSubReviews.push({
                                name: review.name,
                                rating: review.rating,
                                text: review.text,
                                emoji: targetSub.emoji
                            });
                            displayedReviewIndices.add(rIndex);
                        }
                    });

                    furnitureHtml += `
                        <div class="furniture-card" onclick="jumpToHotspot(${spot.pitch}, ${spot.yaw})">
                            <div class="furniture-header">
                                <strong>${displayName} #${index + 1}</strong>
                                <span style="font-size:0.8em; color:#666;">
                                    ğŸ“ ${matchedSubReviews.length > 0 ? matchedSubReviews.length + 'æ¡è¯„è®º' : 'ç‚¹å‡»å®šä½'}
                                </span>
                            </div>
                    `;

                    if (matchedSubReviews.length > 0) {
                        matchedSubReviews.forEach(r => {
                            furnitureHtml += createReviewItemHtml(r);
                        });
                    } else {
                        furnitureHtml += `<div class="review-sub-item" style="color:#999; font-style:italic;">æš‚æ— è¯„ä»·</div>`;
                    }
                    furnitureHtml += `</div>`; 
                });
                furnitureContainer.innerHTML = furnitureHtml;
            }

            // [Part 2] ê¸°íƒ€/ì „ì²´ ë¦¬ë·° ë Œë”ë§ (ìˆ˜ì •ë¨)
            let unmatchedReviews = reviewData.filter((_, index) => !displayedReviewIndices.has(index));

            if (unmatchedReviews.length > 0) {
                unmatchedReviews.forEach(r => {
                    // â˜… ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤!
                    // ì´ì „ ì½”ë“œ: r.sub_reviews ì•ˆì—ì„œë§Œ ì°¾ìŒ -> ì—†ìœ¼ë©´ ê½
                    // ìˆ˜ì • ì½”ë“œ: r.main_emoji(ì„œë²„ê°€ ì €ì¥í•œ ì „ì²´ê°ì •)ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©
                    
                    let displayEmoji = r.main_emoji; // 1ìˆœìœ„: ì „ì²´ ê°ì •

                    // ë§Œì•½ ì˜ˆì „ ë°ì´í„°ë¼ main_emojiê°€ ì—†ìœ¼ë©´ 2ìˆœìœ„ë¡œ sub_reviews í™•ì¸
                    if (!displayEmoji && r.sub_reviews && r.sub_reviews.length > 0) {
                        displayEmoji = r.sub_reviews[0].emoji;
                    }

                    // ê·¸ë˜ë„ ì—†ìœ¼ë©´ ë¹ˆì¹¸
                    if (!displayEmoji) displayEmoji = '';

                    generalHtml += `
                        <div class="furniture-card" style="cursor: default; border-left: 4px solid #aaa;"> 
                            ${createReviewItemHtml({
                                name: r.name,
                                rating: r.rating,
                                text: r.text,
                                emoji: displayEmoji // ì°¾ì•„ë‚¸ ì´ëª¨í‹°ì½˜ ì ìš©
                            })}
                        </div>
                    `;
                });
            } else {
                generalHtml = '<div style="padding:10px; color:#999; font-style:italic;">æ²¡æœ‰å…¶ä»–è¯„è®º</div>';
            }

            generalContainer.innerHTML = generalHtml;
        }

        // HTML ìƒì„± í—¬í¼
        function createReviewItemHtml(r) {
            return `
                <div class="review-sub-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                        <span style="font-weight:bold; color:#007bff; font-size:0.85em;">
                            ${r.name}
                        </span>
                        <span style="color:gold; font-size:0.8em;">${'â­'.repeat(r.rating)}</span>
                    </div>
                    <div style="color:#333; font-size:0.9em; line-height:1.4;">
                        ${r.text} <span style="font-size:1.2em;">${r.emoji || ''}</span>
                    </div>
                </div>
            `;
        }

        function jumpToHotspot(pitch, yaw) {
            if (window.panoramaViewer) {
                window.panoramaViewer.setPitch(pitch, 1000);
                window.panoramaViewer.setYaw(yaw, 1000);
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('review-sidebar');
            const toggleBtn = document.getElementById('toggle-btn');
            const isHidden = sidebar.classList.toggle('hidden');
            
            if (isHidden) {
                toggleBtn.innerHTML = '&#9664;';
                toggleBtn.style.left = '0';
            } else {
                toggleBtn.innerHTML = '&times;';
                toggleBtn.style.left = '-40px';
            }
        }
    </script>
    
    <style>
        .furniture-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }
        .furniture-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .furniture-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .review-sub-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9em;
        }
        .review-sub-item:last-child {
            border-bottom: none;
        }
    </style>
</body>
</html>
